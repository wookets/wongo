// Generated by CoffeeScript 1.6.1
(function() {
  var applyOptions, applyPlugins, ensureIndexes, hooks, mongo, normalize, options, schemas, setupMiddleware, _,
    __hasProp = {}.hasOwnProperty;

  _ = require('underscore');

  hooks = require(__dirname + '/hooks');

  mongo = require(__dirname + '/mongo');

  options = require(__dirname + '/options');

  exports.schemas = schemas = {};

  exports.schema = function(_type, schema) {
    if (!_type || !_.isString(_type)) {
      throw new Error('_type required.');
    }
    if (!schema) {
      if (!schemas[_type]) {
        throw new Error('_type [' + _type + '] not recognized');
      }
      return schemas[_type];
    }
    if (!schema.fields || _.isEmpty(schema.fields)) {
      throw new Error('We need to have some sort of schema or whats the point?');
    }
    normalize(schema.fields);
    applyOptions(schema);
    setupMiddleware(schema);
    applyPlugins(schema);
    ensureIndexes(_type, schema);
    schemas[_type] = schema;
    return schema;
  };

  normalize = function(schema) {
    var field, meta, _results;
    _results = [];
    for (field in schema) {
      if (!__hasProp.call(schema, field)) continue;
      meta = schema[field];
      if (_.isArray(meta)) {
        switch (meta[0]) {
          case String:
          case Number:
          case Boolean:
          case Date:
            schema[field][0] = {
              type: meta[0]
            };
        }
        if (!schema[field][0].type) {
          _results.push(normalize(meta[0]));
        } else {
          _results.push(void 0);
        }
      } else if (!meta.type) {
        switch (meta) {
          case String:
          case Number:
          case Boolean:
          case Date:
            _results.push(schema[field] = {
              type: meta
            });
            break;
          default:
            _results.push(normalize(meta));
        }
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  applyOptions = function(schema) {
    var _base, _ref, _ref1;
    if ((_ref = schema.options) == null) {
      schema.options = {};
    }
    return (_ref1 = (_base = schema.options).convertIdsToStrings) != null ? _ref1 : _base.convertIdsToStrings = options.convertIdsToStrings || true;
  };

  setupMiddleware = function(schema) {
    var afterFind, afterRemove, afterSave, applyDefaults, beforeFind, beforeRemove, beforeSave, generateSubdocIds, populate, prune, validate, _ref, _ref1, _ref10, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9;
    schema.middleware = {
      beforeSave: [],
      afterSave: [],
      beforeFind: [],
      afterFind: [],
      beforeRemove: [],
      afterRemove: []
    };
    prune = (_ref = schema.hooks) != null ? _ref.prune : void 0;
    if (_.isUndefined(prune)) {
      prune = options.prune;
    }
    if (prune === true) {
      prune = hooks.prune;
    }
    if (_.isFunction(prune)) {
      schema.middleware.beforeSave.push(prune);
    }
    applyDefaults = (_ref1 = schema.hooks) != null ? _ref1.applyDefaults : void 0;
    if (_.isUndefined(applyDefaults)) {
      applyDefaults = options.applyDefaults;
    }
    if (applyDefaults === true) {
      applyDefaults = hooks.applyDefaults;
    }
    if (_.isFunction(applyDefaults)) {
      schema.middleware.beforeSave.push(applyDefaults);
    }
    validate = (_ref2 = schema.hooks) != null ? _ref2.validate : void 0;
    if (_.isUndefined(validate)) {
      validate = options.validate;
    }
    if (validate === true) {
      validate = hooks.validate;
    }
    if (_.isFunction(validate)) {
      schema.middleware.beforeSave.push(validate);
    }
    generateSubdocIds = (_ref3 = schema.hooks) != null ? _ref3.generateSubdocIds : void 0;
    if (_.isUndefined(generateSubdocIds)) {
      generateSubdocIds = options.generateSubdocIds;
    }
    if (generateSubdocIds === true) {
      generateSubdocIds = hooks.generateSubdocIds;
    }
    if (_.isFunction(generateSubdocIds)) {
      schema.middleware.beforeSave.push(generateSubdocIds);
    }
    beforeSave = (_ref4 = schema.hooks) != null ? _ref4.beforeSave : void 0;
    if (_.isUndefined(beforeSave)) {
      beforeSave = options.beforeSave;
    }
    if (_.isFunction(beforeSave)) {
      schema.middleware.beforeSave.push(beforeSave);
    }
    afterSave = (_ref5 = schema.hooks) != null ? _ref5.afterSave : void 0;
    if (_.isUndefined(afterSave)) {
      afterSave = options.afterSave;
    }
    if (_.isFunction(afterSave)) {
      schema.middleware.afterSave.push(afterSave);
    }
    beforeFind = (_ref6 = schema.hooks) != null ? _ref6.beforeFind : void 0;
    if (_.isUndefined(beforeFind)) {
      beforeFind = options.beforeFind;
    }
    if (_.isFunction(beforeFind)) {
      schema.middleware.beforeFind.push(beforeFind);
    }
    populate = (_ref7 = schema.hooks) != null ? _ref7.populate : void 0;
    if (_.isUndefined(populate)) {
      populate = options.populate;
    }
    if (populate === true) {
      populate = hooks.populate;
    }
    if (_.isFunction(populate)) {
      schema.middleware.afterFind.push(populate);
    }
    afterFind = (_ref8 = schema.hooks) != null ? _ref8.afterFind : void 0;
    if (_.isUndefined(afterFind)) {
      afterFind = options.afterFind;
    }
    if (_.isFunction(afterFind)) {
      schema.middleware.afterFind.push(afterFind);
    }
    beforeRemove = (_ref9 = schema.hooks) != null ? _ref9.beforeRemove : void 0;
    if (_.isUndefined(beforeRemove)) {
      beforeRemove = options.beforeRemove;
    }
    if (_.isFunction(beforeRemove)) {
      schema.middleware.beforeRemove.push(beforeRemove);
    }
    afterRemove = (_ref10 = schema.hooks) != null ? _ref10.afterRemove : void 0;
    if (_.isUndefined(afterRemove)) {
      afterRemove = options.afterRemove;
    }
    if (_.isFunction(afterRemove)) {
      return schema.middleware.afterRemove.push(afterRemove);
    }
  };

  applyPlugins = function(schema) {
    var plugin, _i, _len, _ref, _ref1, _results;
    _ref1 = (_ref = schema.plugins) != null ? _ref : [];
    _results = [];
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      plugin = _ref1[_i];
      if (_.isArray(plugin)) {
        _results.push(plugin[0](schema, plugin[1]));
      } else {
        _results.push(plugin(schema));
      }
    }
    return _results;
  };

  ensureIndexes = function(_type, schema) {
    var index, _i, _len, _ref, _ref1, _results;
    _ref1 = (_ref = schema.indexes) != null ? _ref : [];
    _results = [];
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      index = _ref1[_i];
      _results.push(mongo.ifConnected(function() {
        if (_.isArray(index)) {
          return mongo.db.ensureIndex(_type, index[0], index[1], function(err) {
            if (err) {
              throw err;
            }
          });
        } else {
          return mongo.db.ensureIndex(_type, index, function(err) {
            if (err) {
              throw err;
            }
          });
        }
      }));
    }
    return _results;
  };

}).call(this);
